# EBB42 USB Toolhead Configuration
# Phase 3 - Tronxy X5SA with SKR 1.4 Turbo
# Version: 1.0
# Date: 2025-12-21

#####################################################################
# EBB42 USB Connection
#####################################################################

[mcu EBBCan]
# USB serial connection to EBB42
# Get the actual ID with: ls /dev/serial/by-id/
serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_XXXXXXXXXXXXXXXX-if00
# Replace XXXXXXXXXXXXXXXX with your actual device ID

#####################################################################
# Extruder Configuration
#####################################################################

[extruder]
# NOTE: Motor E is on SKR E0 during Phase 3-11
# Stepper pins are from SKR 1.4 Turbo
step_pin: PB4              # SKR E0 step
dir_pin: PB3               # SKR E0 dir
enable_pin: !PD2           # SKR E0 enable

# Extruder settings (adjust for your actual extruder)
microsteps: 16
rotation_distance: 33.5    # Calibrate this value
gear_ratio: 50:17          # Adjust if using geared extruder
nozzle_diameter: 0.400
filament_diameter: 1.750

# Heater is on EBB42
heater_pin: EBBCan:PA2     # EBB42 HE0 heater output
max_power: 1.0

# Thermistor is on EBB42
sensor_type: NTC 100K MGB18-104F39050L32  # Generic NTC 100K, adjust if different
sensor_pin: EBBCan:PA3     # EBB42 TH0 thermistor input

# PID tuning (MUST calibrate with PID_CALIBRATE HEATER=extruder TARGET=200)
control: pid
pid_Kp: 22.2               # Placeholder - calibrate!
pid_Ki: 1.08               # Placeholder - calibrate!
pid_Kd: 114                # Placeholder - calibrate!

# Safety limits
min_temp: 0
max_temp: 300
min_extrude_temp: 170
max_extrude_only_distance: 150.0
max_extrude_cross_section: 5.0

# Pressure advance (tune after basic setup works)
#pressure_advance: 0.0      # Calibrate this later
#pressure_advance_smooth_time: 0.040

#####################################################################
# Phase 12 Note: Motor E Migration to EBB42
#####################################################################
# When migrating to Orbiter v2 in Phase 12, update to:
# [extruder]
# step_pin: EBBCan:PD0      # EBB42 E0 step
# dir_pin: EBBCan:PD1       # EBB42 E0 dir
# enable_pin: !EBBCan:PD2   # EBB42 E0 enable
# rotation_distance: 4.637  # Orbiter v2 specific
# gear_ratio: 7.5:1         # Orbiter v2 specific

#####################################################################
# Cooling Fans
#####################################################################

[fan]
# Part cooling fan - FAN0 on EBB42
# Controlled by slicer/gcode (M106/M107)
pin: EBBCan:PA0
kick_start_time: 0.5
off_below: 0.10

# Optional: cycle time for PWM
#cycle_time: 0.01
#hardware_pwm: False

[heater_fan hotend_fan]
# Hotend cooling fan - FAN1 on EBB42
# Always-on when hotend temperature > 50°C
pin: EBBCan:PA1
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0
fan_speed: 1.0

# Optional: silence this fan if PWM is noisy
#cycle_time: 0.01

#####################################################################
# Probe - Omron TL-Q5MC1-Z (NC Configuration - Fail-Safe)
#####################################################################

[probe]
# Omron NC (Normally Closed) connection
# NC pin → PB9, C pin → GND, NO pin not connected
pin: ^EBBCan:PB9           # Pullup enabled (^)

# Physical offsets (MUST measure and adjust for your setup)
x_offset: 0.0              # Measure: probe X position relative to nozzle
y_offset: 25.0             # Measure: probe Y position relative to nozzle
z_offset: 0.0              # Calibrate with PROBE_CALIBRATE command

# Probing speeds and behavior
speed: 5.0                 # Probing speed (mm/s)
lift_speed: 10.0           # Travel speed when not probing
samples: 3                 # Number of probe samples per point
samples_result: median     # Use median of samples
sample_retract_dist: 2.0   # Retract distance between samples
samples_tolerance: 0.01    # Maximum deviation between samples
samples_tolerance_retries: 3

# Optional: probe activation gcode
#activate_gcode:
#deactivate_gcode:

#####################################################################
# Safe Z Homing (uses probe for Z homing)
#####################################################################

[safe_z_home]
# Home XY first, then move to center and probe Z
home_xy_position: 150, 150  # Center of bed (adjust for your bed size)
speed: 50
z_hop: 10                   # Lift Z before homing
z_hop_speed: 5

#####################################################################
# Bed Mesh Leveling (requires functional probe)
#####################################################################

[bed_mesh]
speed: 120
horizontal_move_z: 5        # Z height during travel moves

# Probe area (adjust to your printable area, accounting for probe offset)
mesh_min: 30, 30            # Min X,Y coordinates
mesh_max: 270, 270          # Max X,Y coordinates

# Probe grid
probe_count: 5, 5           # 5x5 grid = 25 probe points
algorithm: bicubic          # Interpolation algorithm

# Fade settings
fade_start: 1               # Start fading correction at this Z height
fade_end: 10                # Fully fade out correction at this Z height
fade_target: 0              # Target Z position after fade

# Optional: increase tolerance for faster probing
#mesh_pps: 2, 2
#bicubic_tension: 0.2

#####################################################################
# SKR Output Pin - 24V Power for EBB42 (Always-On)
#####################################################################

[output_pin ebb42_power]
# FAN2 or HE1 port on SKR used as fixed 24V power supply
# Verify the correct pin for your SKR port choice:
# FAN2: PB11 (verify in SKR 1.4 Turbo pinout)
# HE1: PB10 (verify in SKR 1.4 Turbo pinout)
pin: PB11                   # Example: FAN2 - VERIFY THIS!

pwm: False                  # Not PWM, just on/off
value: 1                    # Always ON (1 = active)
shutdown_value: 0           # Turn off on MCU shutdown

#####################################################################
# Macros for Testing and Calibration
#####################################################################

[gcode_macro TEST_PROBE]
description: Test probe functionality (query state)
gcode:
    QUERY_PROBE
    M118 Probe test - manually trigger sensor and run again

[gcode_macro TEST_FANS]
description: Test both fans at 100% for 3 seconds
gcode:
    M118 Testing part cooling fan...
    M106 S255                    # Part cooling 100%
    G4 P3000                     # Wait 3 seconds
    M107                         # Part cooling off

    M118 Testing hotend fan (heat to 60C)...
    M104 S60                     # Heat hotend to 60C
    M109 S60                     # Wait for temp
    G4 P5000                     # Wait 5 seconds (fan should be running)
    M104 S0                      # Turn off hotend

[gcode_macro CALIBRATE_PROBE_Z_OFFSET]
description: Start interactive probe Z offset calibration
gcode:
    G28                          # Home all axes first
    PROBE_CALIBRATE              # Start calibration routine

[gcode_macro GENERATE_BED_MESH]
description: Generate new bed mesh and save
gcode:
    G28                          # Home all axes
    BED_MESH_CALIBRATE           # Run bed mesh probing
    SAVE_CONFIG                  # Save mesh to config

[gcode_macro PID_TUNE_HOTEND]
description: PID tune hotend at 200C
gcode:
    M106 S64                     # Part cooling at 25% during tuning
    PID_CALIBRATE HEATER=extruder TARGET=200
    M107                         # Turn off part cooling
    SAVE_CONFIG                  # Save PID values

#####################################################################
# Additional Commands for Verification
#####################################################################

# After loading this config:
# 1. Verify EBB42 connection: ls /dev/serial/by-id/
# 2. Update [mcu EBBCan] serial with actual device ID
# 3. Restart Klipper: RESTART
# 4. Check for "MCU 'EBBCan' connected" in logs
# 5. Test thermistor: verify temperature reading is reasonable
# 6. Test probe: QUERY_PROBE (should show "open" or "triggered")
# 7. Calibrate PID: PID_TUNE_HOTEND
# 8. Calibrate probe offset: CALIBRATE_PROBE_Z_OFFSET
# 9. Generate bed mesh: GENERATE_BED_MESH
# 10. Test print small object

#####################################################################
# Safety Notes
#####################################################################

# CRITICAL SAFETY CHECKS:
#
# 1. PROBE FAIL-SAFE TEST:
#    - Run QUERY_PROBE → should show "open"
#    - Manually trigger probe
#    - Run QUERY_PROBE again → should show "triggered"
#    - Disconnect probe cable
#    - Run QUERY_PROBE → should show "triggered" or error
#    - If probe shows "open" when disconnected = WRONG, FIX BEFORE HOMING Z
#
# 2. HEATER THERMAL RUNAWAY:
#    - NEVER leave heater unattended
#    - Monitor first heating cycle closely
#    - Verify temperature rises smoothly
#    - If temperature runs away: EMERGENCY STOP (power off PSU)
#
# 3. Z HOMING SAFETY:
#    - ALWAYS verify probe works with QUERY_PROBE before G28 Z
#    - First Z home: keep hand on emergency stop
#    - Watch nozzle approach to bed, ready to abort
#    - If probe fails: nozzle will crash into bed
#
# 4. 24V POWER POLARITY:
#    - ALWAYS verify with multimeter before connecting
#    - Red wire = +24V, Blue wire = GND
#    - Reversed polarity can damage EBB42
#
# 5. MOTOR E LOCATION:
#    - Phase 3-11: Motor E on SKR (not EBB42)
#    - Do NOT move motor until Phase 12
#    - Verify step_pin: PB4 (SKR E0), NOT EBBCan:PD0

#####################################################################
# End of EBB42 Configuration
#####################################################################
# This file contains ONLY EBB42-related configuration.
# Include it in your main printer.cfg with:
# [include ebb42_klipper_config.cfg]
#
# Your main printer.cfg should still contain:
# - [printer] kinematics and limits
# - [stepper_x/y/z] configurations
# - [tmc2209] drivers configuration
# - [heater_bed] configuration
# - Other printer-specific settings
#####################################################################
