#####################################################################
# TRONXY X5SA - KLIPPER CONFIGURATION
# Hardware: SKR 1.4 Turbo + EBB42 CAN V1.2 (USB Mode)
# Version: 2.0
# Date: 2025-12-21
#####################################################################
#
# HARDWARE SUMMARY:
# - Main MCU: BTT SKR 1.4 Turbo (LPC1769)
# - Toolhead MCU: BTT EBB42 CAN V1.2 (STM32G0B1) via USB
# - Kinematics: CoreXY
# - Build Volume: 330×330×400mm
# - Drivers: 5× TMC2209 UART (X, Y, Z, Z1 on SKR, E on SKR during Phase 3)
# - Hotend Sensor: PT100 with MAX31865 on EBB42
# - Bed Sensor: Thermistor EPCOS 100K B57560G104F
# - Probe: Omron TL-Q5MC1-Z (Inductive NPN NO) on EBB42
# - ADXL345: Integrated on EBB42
#
#####################################################################

[include mainsail.cfg]

#####################################################################
# MCU Configuration
#####################################################################

# Main MCU - SKR 1.4 Turbo (LPC1769)
[mcu]
# Get actual ID with: ls /dev/serial/by-id/
serial: /dev/serial/by-id/usb-Klipper_lpc1769_12345-if00
# Replace with your actual device ID after flashing

# Toolhead MCU - BTT EBB42 CAN V1.2 (STM32G0B1) via USB
[mcu EBBCan]
# Get actual ID with: ls /dev/serial/by-id/
serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_12345-if00
# Replace with your actual device ID after flashing

#####################################################################
# Printer Kinematics
#####################################################################

[printer]
kinematics: corexy
max_velocity: 300
max_accel: 3000
max_z_velocity: 25
max_z_accel: 30

#####################################################################
# X/Y Steppers (CoreXY) - SKR 1.4 Turbo
#####################################################################

[stepper_x]
# X stepper on SKR motor port X
step_pin: P2.2
dir_pin: P2.6              # Remove ! if direction is reversed
enable_pin: !P2.1
microsteps: 32
rotation_distance: 40      # 20T pulley, 2mm pitch belt (20 * 2 = 40)

# Sensorless homing using TMC2209 StallGuard
endstop_pin: tmc2209_stepper_x:virtual_endstop
position_endstop: -1
position_min: -1
position_max: 330

homing_speed: 50           # Conservative for sensorless homing
homing_retract_dist: 0     # Required for sensorless homing
homing_positive_dir: false

[tmc2209 stepper_x]
uart_pin: P1.10
run_current: 0.800         # 800mA - adjust if motors get too hot
hold_current: 0.500        # Reduced current when idle
stealthchop_threshold: 0   # 0 = always use spreadCycle for better torque
interpolate: True

# Sensorless homing configuration
diag_pin: ^P1.29           # Pullup on DIAG pin
driver_SGTHRS: 130         # Sensitivity (0-255, higher=less sensitive)
                           # Tune: start at 130, increase if false triggers

[stepper_y]
# Y stepper on SKR motor port Y
step_pin: P0.19
dir_pin: P0.20             # Remove ! if direction is reversed
enable_pin: !P2.8
microsteps: 32
rotation_distance: 40      # 20T pulley, 2mm pitch belt

# Sensorless homing using TMC2209 StallGuard
endstop_pin: tmc2209_stepper_y:virtual_endstop
position_endstop: 0
position_min: 0
position_max: 330

homing_speed: 50           # Conservative for sensorless homing
homing_retract_dist: 0     # Required for sensorless homing
homing_positive_dir: false

[tmc2209 stepper_y]
uart_pin: P1.9
run_current: 0.800         # 800mA - adjust if motors get too hot
hold_current: 0.500        # Reduced current when idle
stealthchop_threshold: 0   # 0 = always use spreadCycle for better torque
interpolate: True

# Sensorless homing configuration
diag_pin: ^P1.28           # Pullup on DIAG pin
driver_SGTHRS: 130         # Sensitivity (0-255, higher=less sensitive)
                           # Tune: start at 130, increase if false triggers

#####################################################################
# Z Steppers (Dual Independent Z) - SKR 1.4 Turbo
#####################################################################

[stepper_z]
# Z stepper on SKR motor port Z
step_pin: P0.22
dir_pin: !P2.11            # ! reversed - verify with your setup
enable_pin: !P0.21
microsteps: 32
rotation_distance: 8       # 8mm lead screw pitch

# Physical endstop for Z (if installed, otherwise use probe)
# If using probe only, comment endstop_pin and set to probe:z_virtual_endstop
endstop_pin: ^P1.27        # Physical Z endstop (pullup)
#endstop_pin: probe:z_virtual_endstop  # Use this if no physical endstop

position_endstop: 0        # Calibrate after first Z homing
position_min: -2           # Allow slight negative for bed tramming
position_max: 400

homing_speed: 10           # Slow speed for accurate homing
second_homing_speed: 3     # Even slower for precision
homing_retract_dist: 3

[tmc2209 stepper_z]
uart_pin: P1.8
run_current: 0.650         # 650mA for Z motor
hold_current: 0.450        # Hold when idle
stealthchop_threshold: 999999  # Always use stealthChop (quiet)
interpolate: True

[stepper_z1]
# Z1 stepper on SKR motor port E1 (dual Z independent)
step_pin: P1.15
dir_pin: !P1.14            # ! reversed - verify with your setup
enable_pin: !P1.16
microsteps: 32
rotation_distance: 8       # Must match stepper_z

[tmc2209 stepper_z1]
uart_pin: P1.1
run_current: 0.650         # Match stepper_z current
hold_current: 0.450
stealthchop_threshold: 999999
interpolate: True

#####################################################################
# Extruder - PHASE 3: Motor on SKR, Heater/Sensor on EBB42
#####################################################################
# NOTE: During Phase 3-11, the extruder motor is on SKR E0 port.
#       In Phase 12, motor will migrate to EBB42 with Orbiter v2.
#####################################################################

[extruder]
# STEPPER on SKR E0 port (Phase 3-11)
step_pin: P2.13
dir_pin: !P0.11            # Adjust ! if extrusion direction is wrong
enable_pin: !P2.12
microsteps: 16
rotation_distance: 22.478  # Titan clone (gear_ratio 66:22 = 3:1)
                           # Formula: (66/22) * 200 * 16 / (steps * microsteps)
                           # MUST calibrate: https://www.klipper3d.org/Rotation_Distance.html
gear_ratio: 66:22          # Titan clone gear ratio
nozzle_diameter: 0.400
filament_diameter: 1.750

# HEATER on EBB42
heater_pin: EBBCan:PA2     # EBB42 heater output (PA2 for Phase 3)
max_power: 1.0
min_extrude_temp: 170
max_extrude_only_distance: 150.0

# THERMISTOR STOCK (NTC 100K) on EBB42 - Phase 3
sensor_type: EPCOS 100K B57560G104F  # Stock Tronxy thermistor
sensor_pin: EBBCan:PA3     # EBB42 TH0

# PT100 SENSOR - DISABLED (for Phase 12+ with Stealthburner)
#sensor_type: MAX31865
#sensor_pin: EBBCan:PA4     # MAX31865 CS pin
#spi_software_sclk_pin: EBBCan:PB9   # Changed from PA5 to avoid conflict
#spi_software_mosi_pin: EBBCan:PA7
#spi_software_miso_pin: EBBCan:PA6
#rtd_nominal_r: 100         # 100 for PT100, 1000 for PT1000
#rtd_reference_r: 430       # Reference resistor on EBB42 (verify your board)
#rtd_num_of_wires: 2        # 2-wire (adjust to 3 or 4 if using those)
#rtd_use_50Hz_filter: True  # True for 50Hz (Europe), False for 60Hz (Americas)

# Temperature limits
min_temp: 0
max_temp: 300

# PID tuning - MUST CALIBRATE with: PID_CALIBRATE HEATER=extruder TARGET=200
# Temporary values - CALIBRATE ASAP!
control: pid
pid_Kp: 22.2
pid_Ki: 1.08
pid_Kd: 114

# Pressure advance - tune after basic setup works
#pressure_advance: 0.0
#pressure_advance_smooth_time: 0.040

[tmc2209 extruder]
# TMC2209 for extruder on SKR E0 port (Phase 3-11)
uart_pin: P1.4
run_current: 0.650         # 650mA for Titan clone
hold_current: 0.400
stealthchop_threshold: 999999
interpolate: True

#####################################################################
# PHASE 12 MIGRATION NOTE: Orbiter v2 on EBB42
#####################################################################
# When migrating to Orbiter v2 in Phase 12, replace [extruder] with:
#
# [extruder]
# step_pin: EBBCan:PD0
# dir_pin: EBBCan:PD1
# enable_pin: !EBBCan:PD2
# microsteps: 16
# rotation_distance: 4.637
# gear_ratio: 7.5:1         # Orbiter v2 specific
# nozzle_diameter: 0.400
# filament_diameter: 1.750
# heater_pin: EBBCan:PB13
# ... (keep same sensor and PID config)
#
# [tmc2209 extruder]
# uart_pin: EBBCan:PA15
# run_current: 0.850
# stealthchop_threshold: 999999
#####################################################################

#####################################################################
# Heated Bed - SKR 1.4 Turbo
#####################################################################

[heater_bed]
heater_pin: P2.5           # Heated bed output on SKR
sensor_type: EPCOS 100K B57560G104F  # Stock Tronxy thermistor
sensor_pin: P0.25          # Bed thermistor input on SKR

min_temp: 0
max_temp: 130
max_power: 1.0

# PID tuning - MUST CALIBRATE with: PID_CALIBRATE HEATER=heater_bed TARGET=60
# Temporary values - CALIBRATE ASAP!
control: pid
pid_Kp: 54.027
pid_Ki: 0.770
pid_Kd: 948.182

#####################################################################
# Fans - EBB42
#####################################################################

[fan]
# Part cooling fan on EBB42 (controlled by slicer M106/M107)
pin: EBBCan:PA0
kick_start_time: 0.5
off_below: 0.10

[heater_fan hotend_fan]
# Hotend cooling fan on EBB42 (automatic based on hotend temp)
pin: EBBCan:PA1
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0          # Turn on when hotend > 50°C
fan_speed: 1.0             # Full speed

#[fan_generic bed_fan]
# Optional: bed/electronics cooling fan on SKR
#pin: P2.3
#max_power: 1.0
#shutdown_speed: 0
#kick_start_time: 0.5

#####################################################################
# Probe - Tronxy XY-08N (Inductive NPN NO) - EBB42 + SKR
#####################################################################

[probe]
# Tronxy XY-08N inductive sensor (NPN Normally Open, 6-36V)
# Wiring: Brown=+24V (from SKR FAN0), Blue=GND (from SKR FAN0), Black=Signal (to EBB42 PA5)
# Behavior: Open when no metal, pulls to GND when triggered
pin: ^EBBCan:PA5           # ^ enables pullup (required for NPN NO)

# Physical offsets - MEASURE these values for your setup!
x_offset: 0.0              # X distance from nozzle to probe center
y_offset: 25.0             # Y distance from nozzle to probe center (measure!)
z_offset: 0.0              # CALIBRATE ASAP with PROBE_CALIBRATE command

# Probing parameters
speed: 5.0                 # Probing descent speed (mm/s)
lift_speed: 10.0           # Travel speed when not probing
samples: 2                 # Number of samples per point
samples_result: average    # Use average of samples (or median)
sample_retract_dist: 2.0   # Lift between samples
samples_tolerance: 0.050   # Max deviation between samples (mm)
samples_tolerance_retries: 3

#####################################################################
# Safe Z Homing (uses probe for Z homing)
#####################################################################

[safe_z_home]
# Home XY first, then move to center and probe Z
home_xy_position: 165, 165 # Center of 330×330 bed
speed: 50
z_hop: 10                  # Lift Z before homing XY
z_hop_speed: 5

#####################################################################
# Bed Mesh Leveling
#####################################################################

[bed_mesh]
speed: 120
horizontal_move_z: 5       # Z height during travel moves

# Probe area (accounting for probe y_offset of 25mm)
mesh_min: 30, 30           # Min X,Y coordinates
mesh_max: 300, 300         # Max X,Y coordinates (330 - 30 margin)

# Probe grid
probe_count: 5, 5          # 5×5 grid = 25 probe points
algorithm: bicubic         # Bicubic interpolation for smoother mesh

# Fade settings (gradually reduce mesh correction with Z height)
fade_start: 1.0
fade_end: 10.0
fade_target: 0

#####################################################################
# ADXL345 Accelerometer - EBB42 (for Input Shaper)
#####################################################################

[adxl345]
cs_pin: EBBCan:PB12
spi_software_sclk_pin: EBBCan:PB10
spi_software_mosi_pin: EBBCan:PB11
spi_software_miso_pin: EBBCan:PB2
axes_map: x, y, z          # Verify orientation after mounting

[resonance_tester]
accel_chip: adxl345
probe_points:
    165, 165, 20           # Center of bed, 20mm height

# Input shaper configuration (values from resonance testing)
# Uncomment and update after running TEST_RESONANCES
[input_shaper]
#shaper_freq_x: 54.2
#shaper_type_x: mzv
#shaper_freq_y: 42.8
#shaper_type_y: ei

#####################################################################
# Z Tilt Adjustment (for dual Z steppers)
#####################################################################

[z_tilt]
# Z stepper positions (relative to bed)
z_positions:
    -50, 165               # Z stepper position (left)
    380, 165               # Z1 stepper position (right)

# Probe points for leveling (within bed area)
points:
    50, 165                # Left probe point
    280, 165               # Right probe point

speed: 100
horizontal_move_z: 5
retries: 5
retry_tolerance: 0.02      # 20 microns

#####################################################################
# Virtual SD Card
#####################################################################

[virtual_sdcard]
path: /home/mjcuadrado/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

#####################################################################
# Display (if connected)
#####################################################################

#[display]
# Uncomment and configure if you have a display connected to SKR

#####################################################################
# Additional Features
#####################################################################

# Pause/Resume support
[pause_resume]

# Cancel object support (requires slicer support)
[exclude_object]

# Arcs support (G2/G3)
[gcode_arcs]
resolution: 1.0

#####################################################################
# Macros for Testing and Calibration
#####################################################################

[gcode_macro TEST_PROBE]
description: Test probe functionality (query state)
gcode:
    QUERY_PROBE
    M118 Probe test - manually trigger sensor and run again

[gcode_macro TEST_FANS]
description: Test both fans at 100% for 3 seconds each
gcode:
    M118 Testing part cooling fan...
    M106 S255                    # Part cooling 100%
    G4 P3000                     # Wait 3 seconds
    M107                         # Part cooling off

    M118 Testing hotend fan (heat to 60C)...
    M104 S60                     # Heat hotend to 60C
    M109 S60                     # Wait for temp
    G4 P5000                     # Wait 5 seconds (fan should be running)
    M104 S0                      # Turn off hotend

[gcode_macro CALIBRATE_PROBE_Z_OFFSET]
description: Start interactive probe Z offset calibration
gcode:
    G28                          # Home all axes first
    PROBE_CALIBRATE              # Start calibration routine
    # Follow prompts: adjust with TESTZ Z=+/-, then ACCEPT and SAVE_CONFIG

[gcode_macro GENERATE_BED_MESH]
description: Generate new bed mesh and save
gcode:
    G28                          # Home all axes
    Z_TILT_ADJUST                # Level dual Z first
    BED_MESH_CALIBRATE           # Run bed mesh probing
    SAVE_CONFIG                  # Save mesh to config

[gcode_macro PID_TUNE_HOTEND]
description: PID tune hotend at 200C
gcode:
    M106 S64                     # Part cooling at 25% during tuning
    PID_CALIBRATE HEATER=extruder TARGET=200
    M107                         # Turn off part cooling
    SAVE_CONFIG                  # Save PID values

[gcode_macro PID_TUNE_BED]
description: PID tune bed at 60C
gcode:
    PID_CALIBRATE HEATER=heater_bed TARGET=60
    SAVE_CONFIG                  # Save PID values

[gcode_macro TEST_SENSORLESS_HOMING]
description: Test sensorless homing sensitivity
gcode:
    M118 Testing X sensorless homing...
    G28 X
    M118 Testing Y sensorless homing...
    G28 Y
    M118 Sensorless homing test complete

#####################################################################
# CALIBRATION TODO LIST
#####################################################################
#
# After loading this configuration, perform these steps in order:
#
# 1. VERIFY MCU CONNECTIONS
#    - ls /dev/serial/by-id/
#    - Update [mcu] and [mcu EBBCan] serial IDs
#    - RESTART
#
# 2. VERIFY THERMISTORS
#    - Check bed temperature reads room temp (~20-25°C)
#    - Check hotend temperature reads room temp
#
# 3. TEST PROBE
#    - QUERY_PROBE → should show "open"
#    - Manually trigger probe (metal near sensor)
#    - QUERY_PROBE → should show "triggered"
#    - Critical: disconnect probe cable, should show "triggered" or error
#      (if shows "open" when disconnected = DANGEROUS, not fail-safe)
#
# 4. VERIFY MOTOR DIRECTIONS (MOTORS OFF, MOVE TOOLHEAD BY HAND)
#    - Mark current toolhead position
#    - Send: STEPPER_BUZZ STEPPER=stepper_x
#    - X should move toolhead RIGHT (add/remove ! from dir_pin if wrong)
#    - STEPPER_BUZZ STEPPER=stepper_y
#    - Y should move toolhead BACK (add/remove ! from dir_pin if wrong)
#    - STEPPER_BUZZ STEPPER=stepper_z
#    - Z should move bed DOWN (add/remove ! from dir_pin if wrong)
#
# 5. TUNE SENSORLESS HOMING (X and Y)
#    - Start with driver_SGTHRS: 130
#    - Home axis: G28 X
#    - If crashes without stopping: INCREASE SGTHRS (more sensitive)
#    - If stops too early (false trigger): DECREASE SGTHRS (less sensitive)
#    - Repeat for Y axis
#    - Typical range: 100-150
#
# 6. CALIBRATE PID - HOTEND
#    - Run: PID_TUNE_HOTEND
#    - Values will be saved automatically
#
# 7. CALIBRATE PID - BED
#    - Run: PID_TUNE_BED
#    - Values will be saved automatically
#
# 8. CALIBRATE PROBE Z OFFSET
#    - Run: CALIBRATE_PROBE_Z_OFFSET
#    - Use paper test method
#    - Adjust with TESTZ Z=+0.01 or Z=-0.01
#    - ACCEPT when correct
#    - SAVE_CONFIG
#
# 9. LEVEL DUAL Z STEPPERS
#    - Run: Z_TILT_ADJUST
#    - Repeat until tolerance is met
#
# 10. GENERATE BED MESH
#     - Heat bed to printing temp (60°C)
#     - Run: GENERATE_BED_MESH
#     - Mesh will be saved automatically
#
# 11. CALIBRATE E-STEPS (Rotation Distance)
#     - https://www.klipper3d.org/Rotation_Distance.html
#     - Mark filament 120mm from extruder
#     - Extrude 100mm: G91, G1 E100 F100
#     - Measure remaining distance
#     - Calculate: new_rotation_distance = old_rotation_distance * (100 / actual_extruded)
#     - Update rotation_distance in [extruder]
#
# 12. MEASURE PROBE OFFSETS (X and Y)
#     - Home all: G28
#     - Position nozzle at known location: G1 X100 Y100 Z0.2
#     - Mark nozzle position on paper
#     - Run: PROBE
#     - Calculate offsets from marks
#     - Update x_offset and y_offset in [probe]
#
# 13. RUN INPUT SHAPER CALIBRATION
#     - Verify ADXL345 connection: ACCELEROMETER_QUERY
#     - Measure X: TEST_RESONANCES AXIS=X
#     - Measure Y: TEST_RESONANCES AXIS=Y
#     - Generate graphs on host machine
#     - Update [input_shaper] values
#
# 14. FIRST TEST PRINT
#     - Start with small test object (20mm cube)
#     - Monitor first layer closely
#     - Be ready to emergency stop
#
#####################################################################

#####################################################################
# SAFETY WARNINGS
#####################################################################
#
# CRITICAL SAFETY CHECKS BEFORE POWERING ON:
#
# 1. WIRING POLARITY
#    - Verify 24V power polarity with multimeter
#    - Red/Brown = +24V, Blue/Black = GND
#    - Reversed polarity WILL DAMAGE electronics
#
# 2. PROBE FAIL-SAFE
#    - ALWAYS test probe before Z homing
#    - Probe MUST show "triggered" when disconnected (fail-safe)
#    - Keep hand on emergency stop during first Z home
#    - Watch nozzle approach bed, ready to abort
#
# 3. HEATER THERMAL RUNAWAY
#    - NEVER leave heaters unattended
#    - Monitor first heating cycle closely
#    - Verify temperature rises smoothly
#    - If temp runs away: EMERGENCY STOP (power off PSU)
#
# 4. SENSORLESS HOMING TUNING
#    - First homing attempts: reduce speed to 20 mm/s
#    - Keep hand near emergency stop
#    - If motors don't stop at end: STOP IMMEDIATELY
#    - Tune SGTHRS before running at full speed
#
# 5. MOTOR DIRECTIONS
#    - ALWAYS verify directions before first home
#    - Wrong direction = crash into end of axis
#    - Use STEPPER_BUZZ for safe testing
#
#####################################################################

#####################################################################
# End of Configuration
#####################################################################
