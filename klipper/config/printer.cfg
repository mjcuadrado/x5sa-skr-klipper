#####################################################################
# TRONXY X5SA - KLIPPER CONFIGURATION
# Hardware: SKR 1.4 Turbo + EBB42 CAN V1.2 (USB Mode)
# Version: 2.0
# Date: 2025-12-21
#####################################################################
#
# HARDWARE SUMMARY:
# - Main MCU: BTT SKR 1.4 Turbo (LPC1769)
# - Toolhead MCU: BTT EBB42 CAN V1.2 (STM32G0B1) via USB
# - Kinematics: CoreXY
# - Build Volume: 330×330×400mm
# - Drivers: 5× TMC2209 UART (X, Y, Z, Z1 on SKR, E on SKR during Phase 3)
# - Hotend Sensor: PT100 with MAX31865 on EBB42
# - Bed Sensor: Thermistor EPCOS 100K B57560G104F
# - Probe: BIGTREETECH Eddy Coil V1.0 (I2C) on EBB42
# - ADXL345: Integrated on EBB42
#
#####################################################################

[include mainsail.cfg]

#####################################################################
# MCU Configuration
#####################################################################

# Main MCU - SKR 1.4 Turbo (LPC1769)
[mcu]
# Get actual ID with: ls /dev/serial/by-id/
serial: /dev/serial/by-id/usb-Klipper_lpc1769_12345-if00
# Replace with your actual device ID after flashing

# Toolhead MCU - BTT EBB42 CAN V1.2 (STM32G0B1) via USB
[mcu EBBCan]
# Get actual ID with: ls /dev/serial/by-id/
serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_12345-if00
# Replace with your actual device ID after flashing

#####################################################################
# Printer Kinematics
#####################################################################

[printer]
kinematics: corexy
max_velocity: 300
max_accel: 3000
max_z_velocity: 25
max_z_accel: 30

# TEMPORARY: Enable manual position setting during Eddy calibration
[force_move]
enable_force_move: True

#####################################################################
# X/Y Steppers (CoreXY) - SKR 1.4 Turbo
#####################################################################

[stepper_x]
# X stepper on SKR motor port X
step_pin: P2.2
dir_pin: P2.6              # Remove ! if direction is reversed
enable_pin: !P2.1
microsteps: 32
rotation_distance: 40      # 20T pulley, 2mm pitch belt (20 * 2 = 40)

# Sensorless homing using TMC2209 StallGuard
endstop_pin: tmc2209_stepper_x:virtual_endstop
position_endstop: -1
position_min: -1
position_max: 330

homing_speed: 50           # Conservative for sensorless homing
homing_retract_dist: 0     # Required for sensorless homing
homing_positive_dir: false

[tmc2209 stepper_x]
uart_pin: P1.10
# uart_address: 0          # NOT needed on SKR 1.4 Turbo (dedicated UART lines)
run_current: 0.800         # 800mA - adjust if motors get too hot
hold_current: 0.500        # Reduced current when idle
stealthchop_threshold: 0   # 0 = always use spreadCycle for better torque
interpolate: True

# Sensorless homing configuration
diag_pin: ^P1.29           # Pullup on DIAG pin
driver_SGTHRS: 130         # Sensitivity (0-255, higher=less sensitive)
                           # Tune: start at 130, increase if false triggers

[stepper_y]
# Y stepper on SKR motor port Y
step_pin: P0.19
dir_pin: P0.20             # Remove ! if direction is reversed
enable_pin: !P2.8
microsteps: 32
rotation_distance: 40      # 20T pulley, 2mm pitch belt

# Sensorless homing using TMC2209 StallGuard
endstop_pin: tmc2209_stepper_y:virtual_endstop
position_endstop: 0
position_min: 0
position_max: 330

homing_speed: 50           # Conservative for sensorless homing
homing_retract_dist: 0     # Required for sensorless homing
homing_positive_dir: false

[tmc2209 stepper_y]
uart_pin: P1.9
# uart_address: 0          # NOT needed on SKR 1.4 Turbo (dedicated UART lines)
run_current: 0.800         # 800mA - adjust if motors get too hot
hold_current: 0.500        # Reduced current when idle
stealthchop_threshold: 0   # 0 = always use spreadCycle for better torque
interpolate: True

# Sensorless homing configuration
diag_pin: ^P1.28           # Pullup on DIAG pin
driver_SGTHRS: 130         # Sensitivity (0-255, higher=less sensitive)
                           # Tune: start at 130, increase if false triggers

#####################################################################
# Z Steppers (Dual Independent Z) - SKR 1.4 Turbo
#####################################################################

[stepper_z]
# Z stepper on SKR motor port E1 (uses E1-CLS connector)
# Physical: Driver in E1 socket, motor cable to E1-CLS (green connector)
step_pin: P1.15
dir_pin: !P1.14            # Inverted (bed lowers when Z increases)
enable_pin: !P1.16
microsteps: 32
rotation_distance: 8       # 8mm lead screw pitch

# Using Eddy Coil probe as virtual endstop
# Z=0 is at TOP (bed up, near toolhead/Eddy), Z increases DOWNWARDS (bed lowers)
endstop_pin: probe:z_virtual_endstop
#endstop_pin: ^P1.27        # Physical Z endstop (uncomment if you have one)

# position_endstop: NOT used with probe:z_virtual_endstop (auto-calculated)
position_min: -2           # Allow slight negative for bed tramming
position_max: 400

homing_speed: 10           # Slow speed for probing
homing_retract_dist: 5     # Distance to retract after triggering probe
# homing_positive_dir: false is default (home towards Z=0, which is UP for this machine)

[tmc2209 stepper_z]
uart_pin: P1.1             # E1 UART
# uart_address: 0          # NOT needed on SKR 1.4 Turbo (dedicated UART lines)
run_current: 0.650         # 650mA for Z motor
hold_current: 0.450        # Hold when idle
stealthchop_threshold: 0   # Use spreadCycle (more stable)
interpolate: True

[stepper_z1]
# Z1 stepper on SKR motor port E0 (uses E0-CLS connector)
# Physical: Driver in E0 socket, motor cable to E0-CLS (green connector)
step_pin: P2.13
dir_pin: !P0.11            # Inverted (must match stepper_z direction)
enable_pin: !P2.12
microsteps: 32
rotation_distance: 8       # Must match stepper_z

[tmc2209 stepper_z1]
uart_pin: P1.4             # E0 UART
# uart_address: 0          # NOT needed on SKR 1.4 Turbo (dedicated UART lines)
run_current: 0.650         # Match stepper_z current
hold_current: 0.450
stealthchop_threshold: 999999
interpolate: True

#####################################################################
# Extruder - PHASE 3: Motor on SKR, Heater/Sensor on EBB42
#####################################################################
# NOTE: During Phase 3-11, the extruder motor is on SKR E0 port.
#       In Phase 12, motor will migrate to EBB42 with Orbiter v2.
#####################################################################

[extruder]
# STEPPER on EBB42 (Phase 3 - current setup)
# Physical: Motor on EBB42, Titan clone extruder
step_pin: EBBCan:PD0
dir_pin: !EBBCan:PD1       # Inverted - motor was running backwards
enable_pin: !EBBCan:PD2
microsteps: 16
rotation_distance: 12.837  # CALIBRADO Phase 4 - Ajuste muy fino (final)
                           # Medición: extruía 94mm cuando pedía 100mm → 13.656 × (94/100)
                           # Calibration: https://www.klipper3d.org/Rotation_Distance.html
gear_ratio: 22:66          # Titan clone gear ratio (CORRECTO - confirmado en Phase 4)
nozzle_diameter: 0.400
filament_diameter: 1.750

# HEATER on EBB42
heater_pin: EBBCan:PB13    # EBB42 V1.2 heater output (confirmed from schematic)
max_power: 1.0
min_extrude_temp: 170
max_extrude_only_distance: 150.0

# THERMISTOR STOCK (NTC 100K) on EBB42 - Phase 3
sensor_type: EPCOS 100K B57560G104F  # Stock Tronxy thermistor
sensor_pin: EBBCan:PA3     # EBB42 TH0

# PT100 SENSOR - DISABLED (for Phase 12+ with Stealthburner)
#sensor_type: MAX31865
#sensor_pin: EBBCan:PA4     # MAX31865 CS pin
#spi_software_sclk_pin: EBBCan:PB9   # Changed from PA5 to avoid conflict
#spi_software_mosi_pin: EBBCan:PA7
#spi_software_miso_pin: EBBCan:PA6
#rtd_nominal_r: 100         # 100 for PT100, 1000 for PT1000
#rtd_reference_r: 430       # Reference resistor on EBB42 (verify your board)
#rtd_num_of_wires: 2        # 2-wire (adjust to 3 or 4 if using those)
#rtd_use_50Hz_filter: True  # True for 50Hz (Europe), False for 60Hz (Americas)

# Temperature limits
min_temp: 0
max_temp: 300

# PID tuning - MUST CALIBRATE with: PID_CALIBRATE HEATER=extruder TARGET=200
# Temporary values - CALIBRATE ASAP!
control: pid
pid_Kp: 22.2
pid_Ki: 1.08
pid_Kd: 114

# Pressure advance - tune after basic setup works
#pressure_advance: 0.0
#pressure_advance_smooth_time: 0.040

[tmc2209 extruder]
# TMC2209 for extruder on EBB42 (Phase 3 - current setup)
uart_pin: EBBCan:PA15      # EBB42 UART pin for extruder driver
run_current: 0.850         # 850mA for Titan clone (increased from 650mA to fix skipping)
hold_current: 0.500
stealthchop_threshold: 0   # Disabled - use SpreadCycle for better torque
interpolate: True

#####################################################################
# PHASE 12 MIGRATION NOTE: Orbiter v2 on EBB42
#####################################################################
# When migrating to Orbiter v2 in Phase 12, replace [extruder] with:
#
# [extruder]
# step_pin: EBBCan:PD0
# dir_pin: EBBCan:PD1
# enable_pin: !EBBCan:PD2
# microsteps: 16
# rotation_distance: 4.637
# gear_ratio: 7.5:1         # Orbiter v2 specific
# nozzle_diameter: 0.400
# filament_diameter: 1.750
# heater_pin: EBBCan:PB13
# ... (keep same sensor and PID config)
#
# [tmc2209 extruder]
# uart_pin: EBBCan:PA15
# run_current: 0.850
# stealthchop_threshold: 999999
#####################################################################

#####################################################################
# Heated Bed - SKR 1.4 Turbo
#####################################################################

[heater_bed]
heater_pin: P2.5           # Heated bed output on SKR
sensor_type: EPCOS 100K B57560G104F  # Stock Tronxy thermistor
sensor_pin: P0.25          # Bed thermistor input on SKR

min_temp: 0
max_temp: 130
max_power: 1.0

# PID tuning - MUST CALIBRATE with: PID_CALIBRATE HEATER=heater_bed TARGET=60
# Temporary values - CALIBRATE ASAP!
control: pid
pid_Kp: 54.027
pid_Ki: 0.770
pid_Kd: 948.182

#####################################################################
# Fans - EBB42
#####################################################################

[fan]
# Part cooling fan on EBB42 (controlled by slicer M106/M107)
pin: EBBCan:PA0
kick_start_time: 0.5
off_below: 0.10

[heater_fan hotend_fan]
# Hotend cooling fan on EBB42 (automatic based on hotend temp)
pin: EBBCan:PA1
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0          # Turn on when hotend > 50°C
fan_speed: 1.0             # Full speed

#[fan_generic bed_fan]
# Optional: bed/electronics cooling fan on SKR
#pin: P2.3
#max_power: 1.0
#shutdown_speed: 0
#kick_start_time: 0.5

#####################################################################
# Probe - BIGTREETECH Eddy Coil V1.0 (Eddy Current) - EBB42 I2C
#####################################################################

[probe_eddy_current btt_eddy]
# BIGTREETECH Eddy Coil V1.0 connected via I2C to EBB42
# Sensor type: LDC1612 inductive sensor (eddy current)
# Documentation: https://www.klipper3d.org/Eddy_Probe.html
sensor_type: ldc1612

# I2C configuration for EBB42 V1.2
i2c_mcu: EBBCan
i2c_address: 42            # Default I2C address for Eddy Coil
i2c_speed: 100000          # 100kHz I2C speed (reduced for stability)
i2c_software_scl_pin: EBBCan:PB3  # I2C SCL pin on EBB42 V1.2
i2c_software_sda_pin: EBBCan:PB4  # I2C SDA pin on EBB42 V1.2

# Physical offsets - MEASURE these values for your setup!
# Mount Eddy Coil 2-3mm above nozzle tip
x_offset: 0.0              # X distance from nozzle to probe center
y_offset: 0.0              # Y distance from nozzle to probe center
z_offset: 1.0              # Initial value, CALIBRATE with PROBE_EDDY_CURRENT_CALIBRATE

# Probing parameters - OPTIMIZED FOR RAPID SCAN
speed: 120                 # Fast probing speed for rapid_scan mode (was 5.0)
lift_speed: 60.0           # Fast travel speed when not probing (was 10.0)
samples: 2                 # Number of samples per point
samples_result: average    # Use average of samples (or median)
sample_retract_dist: 2.0   # Lift between samples
samples_tolerance: 0.050   # Max deviation between samples (mm)
samples_tolerance_retries: 3

# Calibration data - populated after running LDC_CALIBRATE_DRIVE_CURRENT
# Uncomment and update after calibration:
#reg_drive_current: 15

#####################################################################
# Safe Z Homing (uses probe for Z homing)
#####################################################################

[safe_z_home]
# Home XY first, then move to center and probe Z
home_xy_position: 165, 165 # Center of 330×330 bed
speed: 50
z_hop: 10                  # Lift Z before homing XY
z_hop_speed: 5

#####################################################################
# Bed Mesh Leveling
#####################################################################

[bed_mesh]
speed: 120
horizontal_move_z: 2       # CRITICAL: Lower height for rapid_scan (was 5)

# Probe area (accounting for probe y_offset of 25mm)
mesh_min: 30, 30           # Min X,Y coordinates
mesh_max: 300, 300         # Max X,Y coordinates (330 - 30 margin)

# Probe grid - OPTIMIZED FOR RAPID SCAN
probe_count: 5, 5          # 5×5 grid = 25 points (~15 seconds with rapid_scan)
algorithm: bicubic         # Bicubic interpolation for smoother mesh
scan_overshoot: 8          # Required for rapid_scan mode (overshoot distance)

# Fade settings (gradually reduce mesh correction with Z height)
fade_start: 1.0
fade_end: 10.0
fade_target: 0

# Adaptive bed mesh support (ChipCE implementation)
adaptive_margin: 5         # Margin around print area for adaptive mesh

#####################################################################
# ADXL345 Accelerometer - EBB42 (for Input Shaper)
#####################################################################

[adxl345]
cs_pin: EBBCan:PB12
spi_software_sclk_pin: EBBCan:PB10
spi_software_mosi_pin: EBBCan:PB11
spi_software_miso_pin: EBBCan:PB2
axes_map: x, y, z          # Verify orientation after mounting

[resonance_tester]
accel_chip: adxl345
probe_points:
    165, 165, 20           # Center of bed, 20mm height

# Input shaper configuration (values from resonance testing)
# Uncomment and update after running TEST_RESONANCES
[input_shaper]
#shaper_freq_x: 54.2
#shaper_type_x: mzv
#shaper_freq_y: 42.8
#shaper_type_y: ei

#####################################################################
# Z Tilt Adjustment (for dual Z steppers)
#####################################################################

[z_tilt]
# Z stepper positions (relative to bed)
z_positions:
    -50, 165               # Z stepper position (left)
    380, 165               # Z1 stepper position (right)

# Probe points for leveling (within bed area)
points:
    50, 165                # Left probe point
    280, 165               # Right probe point

speed: 100
horizontal_move_z: 5
retries: 5
retry_tolerance: 0.02      # 20 microns

#####################################################################
# Virtual SD Card
#####################################################################

[virtual_sdcard]
path: /home/mjcuadrado/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

#####################################################################
# Display (if connected)
#####################################################################

#[display]
# Uncomment and configure if you have a display connected to SKR

#####################################################################
# Additional Features
#####################################################################

# Pause/Resume support
[pause_resume]

# Cancel object support (requires slicer support)
[exclude_object]

# Arcs support (G2/G3)
[gcode_arcs]
resolution: 1.0

#####################################################################
# Production Macros - Print Management
#####################################################################

[gcode_macro PRINT_START]
description: Start print sequence with adaptive bed mesh
variable_bed_temp: 60
variable_extruder_temp: 200
gcode:
    # Get temps from slicer
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(200)|float %}
    {% set CHAMBER_TEMP = params.CHAMBER_TEMP|default(0)|float %}

    # Set temperatures (don't wait yet)
    M140 S{BED_TEMP}             # Set bed temp
    M104 S150                    # Set extruder to 150C (prevent oozing)

    # Home all axes
    G28

    # Wait for bed to reach temperature
    M190 S{BED_TEMP}

    # Level dual Z steppers
    Z_TILT_ADJUST

    # Generate adaptive bed mesh using rapid_scan
    # This will only probe the print area + margin
    BED_MESH_CALIBRATE METHOD=rapid_scan ADAPTIVE=1

    # Move to purge position
    G1 X5 Y5 Z10 F6000

    # Heat extruder to printing temperature
    M109 S{EXTRUDER_TEMP}

    # Purge line
    G1 Z0.3 F3000
    G92 E0                       # Reset extruder
    G1 X150 E15 F1500            # Draw purge line
    G1 Y5.4
    G1 X5 E30 F1500              # Draw second purge line
    G92 E0                       # Reset extruder
    G1 Z2.0 F3000                # Lift nozzle

    M117 Printing...

[gcode_macro PRINT_END]
description: End print sequence
gcode:
    # Get print stats
    {% set max_x = printer.toolhead.axis_maximum.x|float %}
    {% set max_y = printer.toolhead.axis_maximum.y|float %}
    {% set max_z = printer.toolhead.axis_maximum.z|float %}
    {% set cur_z = printer.toolhead.position.z|float %}

    # Safe Z retract
    {% if cur_z < (max_z - 10) %}
        G91                      # Relative positioning
        G1 Z10 F600              # Lift Z 10mm
    {% endif %}

    G90                          # Absolute positioning
    G1 X5 Y{max_y - 5} F6000     # Park at rear

    # Turn off heaters
    M104 S0                      # Turn off extruder
    M140 S0                      # Turn off bed

    # Turn off part cooling fan
    M107

    # Retract filament to prevent oozing
    G91                          # Relative positioning
    G1 E-5 F300                  # Retract 5mm
    G90                          # Absolute positioning

    # Disable steppers
    M84

    # Clear bed mesh (optional - remove if you want to keep mesh loaded)
    BED_MESH_CLEAR

    M117 Print complete!

[gcode_macro PAUSE]
rename_existing: PAUSE_BASE
description: Pause print
gcode:
    # Save print state
    SAVE_GCODE_STATE NAME=PAUSE_state
    PAUSE_BASE

    # Retract and lift Z
    G91                          # Relative positioning
    G1 E-2 F2100                 # Retract 2mm
    G1 Z10 F600                  # Lift Z 10mm

    # Move to park position
    G90                          # Absolute positioning
    G1 X5 Y5 F6000               # Park at front left

    # Turn off hotend
    M104 S0

    M117 Print paused

[gcode_macro RESUME]
rename_existing: RESUME_BASE
description: Resume print
gcode:
    # Heat hotend back up
    M109 S{printer.extruder.target}

    # Prime nozzle
    G91                          # Relative positioning
    G1 E2 F2100                  # Unretract 2mm
    G90                          # Absolute positioning

    # Restore print state
    RESTORE_GCODE_STATE NAME=PAUSE_state
    RESUME_BASE

    M117 Resuming print...

[gcode_macro CANCEL_PRINT]
rename_existing: CANCEL_PRINT_BASE
description: Cancel print
gcode:
    # Save current state
    SAVE_GCODE_STATE NAME=CANCEL_state

    # Safe Z retract
    {% set max_z = printer.toolhead.axis_maximum.z|float %}
    {% set cur_z = printer.toolhead.position.z|float %}
    {% if cur_z < (max_z - 10) %}
        G91                      # Relative positioning
        G1 Z10 F600              # Lift Z 10mm
    {% endif %}

    # Park toolhead
    G90                          # Absolute positioning
    G1 X5 Y{printer.toolhead.axis_maximum.y - 5} F6000

    # Turn off heaters
    M104 S0
    M140 S0

    # Turn off fan
    M107

    # Disable steppers
    M84

    # Clear bed mesh
    BED_MESH_CLEAR

    # Cancel print
    CANCEL_PRINT_BASE

    M117 Print cancelled

#####################################################################
# Calibration Macros
#####################################################################

[gcode_macro CALIBRATE_EDDY_CURRENT]
description: Calibrate Eddy Coil drive current and Z offset
gcode:
    M118 Step 1: Calibrating drive current...
    LDC_CALIBRATE_DRIVE_CURRENT CHIP=btt_eddy
    M118 Step 2: Calibrating Z offset...
    G28                          # Home all axes first
    PROBE_EDDY_CURRENT_CALIBRATE CHIP=btt_eddy
    # Follow prompts: adjust with TESTZ Z=+/-, then ACCEPT and SAVE_CONFIG

[gcode_macro GENERATE_BED_MESH]
description: Generate full bed mesh with rapid_scan
gcode:
    G28                          # Home all axes
    Z_TILT_ADJUST                # Level dual Z first
    BED_MESH_CALIBRATE METHOD=rapid_scan  # Use rapid_scan mode
    SAVE_CONFIG                  # Save mesh to config

[gcode_macro PID_TUNE_HOTEND]
description: PID tune hotend at target temp
gcode:
    {% set TARGET = params.TARGET|default(200)|float %}
    M106 S64                     # Part cooling at 25% during tuning
    PID_CALIBRATE HEATER=extruder TARGET={TARGET}
    M107                         # Turn off part cooling
    SAVE_CONFIG                  # Save PID values

[gcode_macro PID_TUNE_BED]
description: PID tune bed at target temp
gcode:
    {% set TARGET = params.TARGET|default(60)|float %}
    PID_CALIBRATE HEATER=heater_bed TARGET={TARGET}
    SAVE_CONFIG                  # Save PID values

[gcode_macro CALIBRATE_EXTRUDER]
description: E-steps calibration helper (rotation_distance)
gcode:
    M118 E-Steps Calibration:
    M118 1. Mark filament 120mm from extruder
    M118 2. Heat hotend: M109 S200
    M118 3. Extrude 100mm: G91 then G1 E100 F60
    M118 4. Measure remaining distance from mark
    M118 5. Calculate: new_rotation_distance = current_rotation_distance * (100 / actual_extruded)
    M118 6. Update [extruder] rotation_distance in printer.cfg
    M118 Current rotation_distance: {printer.configfile.settings.extruder.rotation_distance}

[gcode_macro PRESSURE_ADVANCE_CALIBRATION]
description: Pressure advance tuning pattern
gcode:
    {% set PA_START = params.PA_START|default(0.0)|float %}
    {% set PA_END = params.PA_END|default(0.1)|float %}
    {% set PA_STEP = params.PA_STEP|default(0.005)|float %}

    M118 Pressure Advance Calibration:
    M118 Range: {PA_START} to {PA_END}, step {PA_STEP}
    M118 Use Ellis' PA calibration pattern generator:
    M118 https://ellis3dp.com/Print-Tuning-Guide/articles/pressure_advance.html

    # Set starting PA
    SET_PRESSURE_ADVANCE ADVANCE={PA_START}
    M118 Starting PA: {PA_START}

[gcode_macro RETRACTION_CALIBRATION]
description: Retraction tuning helper
gcode:
    M118 Retraction Calibration:
    M118 Current firmware retraction settings:
    M118 - Distance: {printer.firmware_retraction.retract_length}mm
    M118 - Speed: {printer.firmware_retraction.retract_speed}mm/s
    M118 - Unretract extra: {printer.firmware_retraction.unretract_extra_length}mm
    M118 - Unretract speed: {printer.firmware_retraction.unretract_speed}mm/s
    M118
    M118 Test with retraction tower STL or Orca Slicer calibration
    M118 Typical ranges:
    M118 - Direct drive: 0.5-2mm @ 30-50mm/s
    M118 - Bowden: 4-8mm @ 40-60mm/s

[gcode_macro TEST_SPEED]
description: Test max speed and acceleration (Ellis guide)
gcode:
    # Parameters
    {% set speed = params.SPEED|default(300)|int %}
    {% set iterations = params.ITERATIONS|default(5)|int %}
    {% set accel = params.ACCEL|default(3000)|int %}

    # Save current settings
    {% set max_accel = printer.configfile.settings.printer.max_accel %}
    {% set max_accel_to_decel = printer.configfile.settings.printer.max_accel_to_decel %}
    {% set max_velocity = printer.configfile.settings.printer.max_velocity %}

    # Set test parameters
    SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}

    # Home if needed
    {% if printer.toolhead.homed_axes != "xyz" %}
        G28
    {% endif %}

    # Move to center
    G0 X{printer.toolhead.axis_maximum.x / 2} Y{printer.toolhead.axis_maximum.y / 2} Z50 F{speed * 60}

    # Run test pattern
    M118 Testing speed {speed}mm/s with {accel}mm/s² accel...
    {% for i in range(iterations) %}
        M118 Iteration {i+1}/{iterations}
        G0 X{printer.toolhead.axis_minimum.x + 50} Y{printer.toolhead.axis_minimum.y + 50} F{speed * 60}
        G0 X{printer.toolhead.axis_maximum.x - 50} Y{printer.toolhead.axis_maximum.y - 50} F{speed * 60}
        G0 X{printer.toolhead.axis_minimum.x + 50} Y{printer.toolhead.axis_maximum.y - 50} F{speed * 60}
        G0 X{printer.toolhead.axis_maximum.x - 50} Y{printer.toolhead.axis_minimum.y + 50} F{speed * 60}
    {% endfor %}

    # Restore original settings
    SET_VELOCITY_LIMIT VELOCITY={max_velocity} ACCEL={max_accel} ACCEL_TO_DECEL={max_accel_to_decel}

    M118 Speed test complete!

#####################################################################
# Testing and Verification Macros
#####################################################################

[gcode_macro TEST_EDDY_PROBE]
description: Test Eddy Coil probe functionality
gcode:
    QUERY_PROBE
    M118 Eddy Coil probe test - move metal near coil and run again

[gcode_macro VERIFY_EDDY_PROBE]
description: Safety check before using Eddy probe
gcode:
    M118 ===== EDDY COIL SAFETY CHECK =====
    M118 1. Testing probe in air (should be OPEN)...
    QUERY_PROBE
    G4 P2000
    M118 2. Place metal object near coil now!
    G4 P3000
    M118 3. Testing probe with metal (should be TRIGGERED)...
    QUERY_PROBE
    M118 4. Remove metal object
    G4 P2000
    M118 5. Final test (should be OPEN again)...
    QUERY_PROBE
    M118 ===== SAFETY CHECK COMPLETE =====

[gcode_macro TEST_FANS]
description: Test both fans at 100% for 3 seconds each
gcode:
    M118 Testing part cooling fan...
    M106 S255                    # Part cooling 100%
    G4 P3000                     # Wait 3 seconds
    M107                         # Part cooling off

    M118 Testing hotend fan (heat to 60C)...
    M104 S60                     # Heat hotend to 60C
    M109 S60                     # Wait for temp
    G4 P5000                     # Wait 5 seconds (fan should be running)
    M104 S0                      # Turn off hotend
    M118 Fan test complete

[gcode_macro TEST_SENSORLESS_HOMING]
description: Test sensorless homing sensitivity
gcode:
    M118 Testing X sensorless homing...
    G28 X
    M118 Testing Y sensorless homing...
    G28 Y
    M118 Sensorless homing test complete

#####################################################################
# Firmware Retraction Configuration
#####################################################################

[firmware_retraction]
retract_length: 1.0           # Direct drive starting point (tune with RETRACTION_CALIBRATION)
retract_speed: 40             # mm/s
unretract_extra_length: 0.0   # Additional length on unretract
unretract_speed: 40           # mm/s

#####################################################################
# CALIBRATION TODO LIST
#####################################################################
#
# After loading this configuration, perform these steps in order:
#
# 1. VERIFY MCU CONNECTIONS
#    - ls /dev/serial/by-id/
#    - Update [mcu] and [mcu EBBCan] serial IDs
#    - RESTART
#
# 2. VERIFY THERMISTORS
#    - Check bed temperature reads room temp (~20-25°C)
#    - Check hotend temperature reads room temp
#
# 3. TEST EDDY COIL PROBE
#    - Run: PROBE_EDDY_CURRENT_CALIBRATE CHIP=btt_eddy
#    - Follow on-screen instructions
#    - This will calibrate the drive current for optimal sensitivity
#
# 4. VERIFY MOTOR DIRECTIONS (MOTORS OFF, MOVE TOOLHEAD BY HAND)
#    - Mark current toolhead position
#    - Send: STEPPER_BUZZ STEPPER=stepper_x
#    - X should move toolhead RIGHT (add/remove ! from dir_pin if wrong)
#    - STEPPER_BUZZ STEPPER=stepper_y
#    - Y should move toolhead BACK (add/remove ! from dir_pin if wrong)
#    - STEPPER_BUZZ STEPPER=stepper_z
#    - Z should move bed DOWN (add/remove ! from dir_pin if wrong)
#
# 5. TUNE SENSORLESS HOMING (X and Y)
#    - Start with driver_SGTHRS: 130
#    - Home axis: G28 X
#    - If crashes without stopping: INCREASE SGTHRS (more sensitive)
#    - If stops too early (false trigger): DECREASE SGTHRS (less sensitive)
#    - Repeat for Y axis
#    - Typical range: 100-150
#
# 6. CALIBRATE PID - HOTEND
#    - Run: PID_TUNE_HOTEND
#    - Values will be saved automatically
#
# 7. CALIBRATE PID - BED
#    - Run: PID_TUNE_BED
#    - Values will be saved automatically
#
# 8. CALIBRATE EDDY COIL Z OFFSET
#    - First run: LDC_CALIBRATE_DRIVE_CURRENT CHIP=btt_eddy
#    - Then run: PROBE_EDDY_CURRENT_CALIBRATE CHIP=btt_eddy
#    - Use paper test method to set Z=0
#    - Follow Klipper prompts
#    - SAVE_CONFIG when complete
#
# 9. LEVEL DUAL Z STEPPERS
#    - Run: Z_TILT_ADJUST
#    - Repeat until tolerance is met
#
# 10. GENERATE BED MESH
#     - Heat bed to printing temp (60°C)
#     - Run: GENERATE_BED_MESH
#     - Mesh will be saved automatically
#
# 11. CALIBRATE E-STEPS (Rotation Distance)
#     - https://www.klipper3d.org/Rotation_Distance.html
#     - Mark filament 120mm from extruder
#     - Extrude 100mm: G91, G1 E100 F100
#     - Measure remaining distance
#     - Calculate: new_rotation_distance = old_rotation_distance * (100 / actual_extruded)
#     - Update rotation_distance in [extruder]
#
# 12. MEASURE PROBE OFFSETS (X and Y)
#     - Home all: G28
#     - Position nozzle at known location: G1 X100 Y100 Z0.2
#     - Mark nozzle position on paper
#     - Run: PROBE
#     - Calculate offsets from marks
#     - Update x_offset and y_offset in [probe]
#
# 13. RUN INPUT SHAPER CALIBRATION
#     - Verify ADXL345 connection: ACCELEROMETER_QUERY
#     - Measure X: TEST_RESONANCES AXIS=X
#     - Measure Y: TEST_RESONANCES AXIS=Y
#     - Generate graphs on host machine
#     - Update [input_shaper] values
#
# 14. FIRST TEST PRINT
#     - Start with small test object (20mm cube)
#     - Monitor first layer closely
#     - Be ready to emergency stop
#
#####################################################################

#####################################################################
# SAFETY WARNINGS
#####################################################################
#
# CRITICAL SAFETY CHECKS BEFORE POWERING ON:
#
# 1. WIRING POLARITY
#    - Verify 24V power polarity with multimeter
#    - Red/Brown = +24V, Blue/Black = GND
#    - Reversed polarity WILL DAMAGE electronics
#
# 2. PROBE FAIL-SAFE
#    - ALWAYS test probe before Z homing
#    - Probe MUST show "triggered" when disconnected (fail-safe)
#    - Keep hand on emergency stop during first Z home
#    - Watch nozzle approach bed, ready to abort
#
# 3. HEATER THERMAL RUNAWAY
#    - NEVER leave heaters unattended
#    - Monitor first heating cycle closely
#    - Verify temperature rises smoothly
#    - If temp runs away: EMERGENCY STOP (power off PSU)
#
# 4. SENSORLESS HOMING TUNING
#    - First homing attempts: reduce speed to 20 mm/s
#    - Keep hand near emergency stop
#    - If motors don't stop at end: STOP IMMEDIATELY
#    - Tune SGTHRS before running at full speed
#
# 5. MOTOR DIRECTIONS
#    - ALWAYS verify directions before first home
#    - Wrong direction = crash into end of axis
#    - Use STEPPER_BUZZ for safe testing
#
#####################################################################

#####################################################################
# End of Configuration
#####################################################################

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 15
#*# calibrate =
#*#     0.050000:3323819.781,0.090000:3323589.356,0.130000:3323371.071,
#*#     0.170000:3323153.098,0.210000:3322892.112,0.250000:3322629.966,
#*#     0.290000:3322327.132,0.330000:3322024.552,0.370000:3321764.631,
#*#     0.410000:3321466.711,0.450000:3321238.082,0.490000:3320985.337,
#*#     0.530000:3320734.445,0.570000:3320409.962,0.610000:3320120.652,
#*#     0.650000:3318722.137,0.690000:3315764.068,0.730000:3312515.681,
#*#     0.770000:3309419.954,0.810000:3306422.476,0.850000:3303785.303,
#*#     0.890000:3301067.364,0.930000:3298296.095,0.970000:3295682.616,
#*#     1.010000:3293369.737,1.050000:3291078.549,1.090000:3288861.290,
#*#     1.130000:3286687.244,1.170000:3284579.346,1.210000:3282577.595,
#*#     1.250000:3280545.927,1.290000:3278509.914,1.330000:3276611.797,
#*#     1.370000:3274612.709,1.410000:3272628.161,1.450000:3270725.464,
#*#     1.490000:3268980.984,1.530000:3267221.981,1.570000:3265410.538,
#*#     1.610000:3263690.767,1.650000:3262252.697,1.690000:3260804.105,
#*#     1.730000:3259319.220,1.770000:3257715.211,1.810000:3256302.822,
#*#     1.850000:3254941.853,1.890000:3253601.190,1.930000:3252518.242,
#*#     1.970000:3251319.455,2.010000:3250132.837,2.050000:3249050.723,
#*#     2.090000:3247956.539,2.130000:3246984.222,2.170000:3245984.118,
#*#     2.210000:3245116.916,2.250000:3244144.646,2.290000:3243336.232,
#*#     2.330000:3242395.077,2.370000:3241396.360,2.410000:3240317.160,
#*#     2.450000:3239344.890,2.490000:3238294.965,2.530000:3237351.826,
#*#     2.570000:3236364.695,2.610000:3235469.890,2.650000:3234554.901,
#*#     2.690000:3233709.514,2.730000:3232893.929,2.770000:3232136.833,
#*#     2.810000:3231368.791,2.850000:3230591.689,2.890000:3229819.978,
#*#     2.930000:3229085.194,2.970000:3228396.590,3.010000:3227686.951,
#*#     3.050000:3226973.215,3.090000:3226313.168,3.130000:3225663.308,
#*#     3.170000:3225025.100,3.210000:3224360.856,3.250000:3223782.064,
#*#     3.290000:3223167.245,3.330000:3222570.303,3.370000:3221967.126,
#*#     3.410000:3221423.712,3.450000:3220859.318,3.490000:3220338.734,
#*#     3.530000:3219780.909,3.570000:3219287.512,3.610000:3218745.212,
#*#     3.650000:3218308.888,3.690000:3217793.022,3.730000:3217355.028,
#*#     3.770000:3216894.254,3.810000:3216407.359,3.850000:3215939.405,
#*#     3.890000:3215484.554,3.930000:3215046.423,3.970000:3214622.669,
#*#     4.010000:3214175.777,4.050000:3213795.694
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*#     0.016291, -0.116552, -0.216627, -0.431452, -0.716334
#*#     -0.096432, -0.134087, -0.180578, -0.366674, -0.639776
#*#     -0.071604, -0.124185, -0.165897, -0.314013, -0.600080
#*#     -0.384690, -0.279115, -0.275156, -0.388701, -0.687170
#*#     -0.717407, -0.563732, -0.457982, -0.513751, -0.775220
#*# x_count = 5
#*# y_count = 5
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 300.0
#*# min_y = 30.0
#*# max_y = 300.0
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 16.649
#*# pid_ki = 0.516
#*# pid_kd = 134.231
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 67.938
#*# pid_ki = 1.402
#*# pid_kd = 822.899
